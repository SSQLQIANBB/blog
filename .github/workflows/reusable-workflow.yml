name: Reusable Deploy Workflow
on:
  workflow_call:  # 声明为可复用工作流
    inputs:
      trigger-source:
        description: "触发来源（api/push）"
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 步骤1：检出代码（必须放在最前面，初始化Git环境）
      - uses: actions/checkout@v2

      # 步骤2：安装Node环境
      - uses: actions/setup-node@v3
        with:
          node-version: 20

      # 步骤3：安装依赖
      - run: npm i pnpm -g
      - run: pnpm install

      # 步骤4：仅API触发时同步Notion（根据需求过滤）
      - name: 拉取Notion文章（仅API触发）
        if: inputs.trigger-source == 'api'
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        run: pnpm sync

      # 步骤5：检查是否有变更（避免空提交）
      - name: 检查变更
        id: check-changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      # 步骤6：提交变更（仅当有变更时）
      - name: 提交变更
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          git config --global user.name "SSQLQIANBB"
          git config --global user.email "1215323732@qq.com"
          echo `date +"%Y-%m-%d %H:%M:%S"` > time.txt
          git add .
          git commit -m "[bot] 更新文档（来源：${{ inputs.trigger-source }}）"

      # 步骤7：推送变更（仅当有变更时）
      - name: 推送变更
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      # 步骤8：构建文档
      - name: 构建文档
        run: pnpm docs:build

      # 步骤9：部署到GitHub Pages
      - name: 部署到gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: docs/.vitepress/dist